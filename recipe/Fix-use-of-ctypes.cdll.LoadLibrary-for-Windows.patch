From 10195f8bab5ffbd7371623b262fe152c929818b4 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Thu, 15 Dec 2022 09:36:51 +0100
Subject: [PATCH] Fix use of ctypes.cdll.LoadLibrary for Windows

---
 setup.py | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/setup.py b/setup.py
index 444c369..f01f4d2 100644
--- a/setup.py
+++ b/setup.py
@@ -76,8 +76,16 @@ def openssl_version(ossldir, req_ver, required=False):
              OpenSSL has been installed.
     """
     try:
-        import ctypes
-        libssl = ctypes.cdll.LoadLibrary("libssl.so")
+        import ctypes.util
+        libssl_path = ctypes.util.find_library("ssl")
+        if libssl_path is None and sys.platform == "win32":
+            libssl_path = os.path.join(os.environ["PREFIX"], "Library", "lib", "libssl.lib")
+        print("libssl_path =", libssl_path)
+        if libssl_path is None:
+            raise NotImplementedError("Did not find libssl")
+        if os.path.isfile(libssl_path):
+            raise NotImplementedError("Found libssl but it does not exist!")
+        libssl = ctypes.cdll.LoadLibrary(libssl_path)
         ver = libssl.OpenSSL_version_num()
         log.debug("ctypes: ver = %s", hex(ver))
     # for OpenSSL < 1.1.0
-- 
2.38.1

